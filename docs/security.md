# セキュリティとコンプライアンス

## 基本方針

- **Denylist** を標準 ON（`secrets/`, `*.pem`, `*.key`, `.env*`, `config/*.prod.*` など）。
- **機密検出**: 高エントロピー文字列や既知の鍵パターンを検知し、格納拒否またはマスキングを実施する。
- **MCP 出力制御**: ツール単位で生本文返却禁止や要約のみ返却を選択できるポリシを整備する。
- **DB 暗号化**: 少なくともファイルシステムレベルで暗号化し、DuckDB の暗号化オプションも検討する。
- **監査ログ**: 外部 LLM に渡したパスと行範囲を記録し、週次レビューを義務化する。

## Denylist 初期値

```
secrets/**, **/*.pem, **/*.key, **/.env*, **/config/*.prod.*, **/node_modules/**,
**/build/**, **/dist/**, **/.git/**, **/*.sqlite, **/*.duckdb, **/*.db
```

**パターン検証**: Denylist パターンは glob 構文をサポートし、`*`（ワイルドカード）と `**`（再帰マッチ）を使用できる。
パターンは起動時に検証され、以下の制限が適用される：

- 最大長: 500文字
- 複雑度: 3個以上の量指定子（`*`, `+`, `{}`）を含むパターンは拒否される（ReDoS対策）

不正なパターンが検出された場合、インデクサーは起動時にエラーを返す。

## セキュリティ設定と検証フロー

- 運用時の権限境界は `config/security.yml` に定義する。`allowed_paths`、`allow_network_egress`、`allow_subprocess` を明示し、
  `sensitive_tokens` にはマスキング対象のトークン接頭辞を列挙する。
- **スキーマ検証**: 設定ファイルは起動時に Zod スキーマで検証され、必須フィールドの欠落や型エラーがあればサーバー起動をブロックする。
- 設定ファイルの改ざんを検知するため、`var/security.lock` に SHA-256 ハッシュを保存する。差分がある場合はサーバー起動前に
  ブロックされる。
- CLI から `pnpm exec tsx src/client/cli.ts security verify --write-lock` を実行すると現在の設定を検証し、ロックファイルが存在しな
  ければ生成する。
- CI では `pnpm exec tsx src/client/cli.ts security verify` を最初のステップとして実行し、差分がないことを保証する。

## MCP 応答のマスキング

- `src/shared/security/masker.ts` でマスキングユーティリティを提供し、`context_bundle` などサーバー側で返却するすべてのペイロード
  に対して `***` へ置換する。
- **ReDoS 対策**: マスキングパターンは起動時に検証され、長さ（最大100文字）と複雑度（ネストした量指定子の禁止）がチェックされる。
  悪意のあるパターンによる CPU 使用率の急上昇を防止する。
- マスキング件数はメトリクス (`/metrics`) に `kiri_mask_applied_total` として公開され、運用監視で確認できる。
- 監査ログ (`scripts/audit/export-log.ts`) からエクスポートされる JSON もマスキング済みフィールドのみを含む。

## Degrade 発生時の運用ポリシー

- DuckDB/VSS が利用できない場合、`--allow-degrade` フラグを付けてサーバーを起動するとファイル検索のみ許可するセーフモードに
  移行する。その他ツールは 503 を返す。
- Degrade 状態は `/metrics` のレスポンスタイム増加と監査ログのイベントで検知できる。復旧後はサーバーを再起動して通常モードに
  戻す。

## Windows プラットフォームにおけるセキュリティ考慮事項

### IPC メカニズムとアクセス制御

KIRI はデーモンアーキテクチャで IPC（プロセス間通信）を使用します。プラットフォームごとに異なる IPC メカニズムを採用しており、
セキュリティ特性も異なります。

#### Unix/Linux/macOS: Unix ドメインソケット

- **メカニズム**: ファイルシステムベースのソケットファイル（例: `/path/to/database.duckdb.sock`）
- **アクセス制御**: POSIX ファイルパーミッション（0600）により所有者のみがアクセス可能
- **セキュリティレベル**: 高（OS レベルのアクセス制御により保護）

#### Windows: 名前付きパイプ

- **メカニズム**: Windows 名前付きパイプ（例: `\\.\pipe\kiri-<hash>`）
- **アクセス制御**: デフォルト ACL（Access Control List）を使用
- **セキュリティレベル**: 中（同一システム上の他ユーザーがアクセス可能な場合がある）

**重要な制限事項**:

- Node.js の標準 `net` モジュールでは、名前付きパイプ作成時に明示的な ACL を設定できない
- デフォルトの ACL では、場合によって同一マシン上の他のローカルユーザーがパイプに接続可能

### セキュリティ対策と緩和策

#### 1. パイプ名の曖昧性による保護

```typescript
// データベースパスの SHA256 ハッシュからパイプ名を生成
const hash = crypto.createHash("sha256").update(databasePath).digest("hex");
const pipeName = `kiri-${hash.substring(0, 16)}`;
// 結果: \\.\pipe\kiri-a1b2c3d4e5f6g7h8
```

- パイプ名は予測困難なハッシュベース
- ブルートフォース攻撃に対する耐性を提供
- **注意**: これは「曖昧性によるセキュリティ」であり、適切なアクセス制御の代替ではない

#### 2. 環境変数によるカスタマイズ

追加のセキュリティ層として、パイプ名のプレフィックスをカスタマイズ可能：

```bash
# デフォルト
# \\.\pipe\kiri-a1b2c3d4e5f6g7h8

# カスタムプレフィックス
export KIRI_PIPE_PREFIX=mycompany-secret
# \\.\pipe\mycompany-secret-a1b2c3d4e5f6g7h8
```

**推奨事項**:

- 本番環境では `KIRI_PIPE_PREFIX` にランダムな値を設定
- プレフィックスは秘密として扱い、ドキュメントや共有設定ファイルに記載しない

### Windows 環境での運用推奨事項

#### 適切な利用環境

✅ **推奨される環境**:

- 個人用デスクトップ（単一ユーザー）
- 信頼できる開発環境
- 専用の開発マシン

❌ **推奨されない環境**:

- マルチユーザーサーバー
- 共有開発環境
- 信頼できないユーザーがアクセス可能なシステム

#### 代替案

マルチユーザー環境や高セキュリティ要件がある場合は、以下の代替案を検討：

1. **WSL2（Windows Subsystem for Linux 2）の使用**
   - Unix ドメインソケットによる適切なアクセス制御
   - POSIX パーミッションモデルの活用
   - 推奨される構成:
     ```bash
     # WSL2 内で実行
     npm install -g kiri-mcp-server
     kiri --repo /mnt/c/path/to/repo --db ~/.kiri/index.duckdb
     ```

2. **ネットワーク分離の実装**
   - Windows Firewall による接続制限
   - ローカルホストのみの通信に限定

3. **Docker コンテナの使用**
   - Linux ベースのコンテナ内で KIRI を実行
   - ホストとの通信は Docker のネットワーク機能で制御

### セキュリティ監査

Windows 環境での運用時は、以下の監査項目を定期的に確認：

- [ ] `KIRI_PIPE_PREFIX` が設定されているか
- [ ] 信頼できないユーザーがシステムにアクセスできないか
- [ ] デーモンログに不審な接続試行が記録されていないか（`/path/to/database.duckdb.daemon.log`）
- [ ] プロセス監視ツールで KIRI デーモンの親プロセスが正しいユーザーで実行されているか

### 既知の制限事項

- **ACL 設定の不可**: 現時点では Node.js 標準機能で名前付きパイプの ACL を明示的に設定できない
- **将来の改善**: ネイティブモジュール（`node-windows`、`ffi-napi` など）による ACL 設定を検討中
